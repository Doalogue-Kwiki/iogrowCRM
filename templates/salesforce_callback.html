<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="https://storage.googleapis.com/iogrowgs/jquery.min.js"></script>
    <script src="https://checkout.stripe.com/checkout.js"></script>
</head>
<body>
  
  <script>
      var OAuthHelper = {};
      var handler = StripeCheckout.configure({
      key: 'pk_live_4Xa3cFwLO3vTgdjpjnC6gmAD',
      image: 'https://storage.googleapis.com/iogrow-gs/Logo-iogrow.png',
      token: function(token) {
        // Use the token to create the charge with a server-side script.
        // You can access the token ID with `token.id`
        // send the token to stripe
        //sfsubscriber
        console.log('token');
        console.log(token);

        $.ajax({
            type: 'POST',
            url: '/sfsubscriber',

            success: function(result) {
              console.log(result);
              parentWindow.postMessage(OAuthHelper,
                  "*");
              window.close();
            },
            error:function(result){
              console.log(result);  
                
            },
            data: {token:JSON.stringify(token),email:OAuthHelper.user_email}
        });
        
      }
      });

      

      // Close Checkout on page navigation
      $(window).on('popstate', function() {
        handler.close();
      });
      var match = window.location.href.match(/code=([^&]+)/) ; 
      var parentWindow = window.opener.parent;
      console.log(match);
      $.ajax({
            type: 'GET',
            url: '/sfconnect',
            datatype:'json',

            success: function(result) {
              console.log('i am in connectServer show me result please');
              console.log(result);
              
               window.close();
            },
            error:function(result){
                var response = result.responseText;
                var rr= response.replace(/'/g,"\"");
                console.log('yyyyy');
                console.log(JSON.parse(rr));
                var oauthResult = JSON.parse(rr);
                OAuthHelper=oauthResult;
                if(oauthResult.show_checkout=="true"){
                    handler.open({
                    name: 'ioGrow LLC',
                    description: 'LinkedIn to Salesforce extension.',
                    amount: 1500,
                    email:oauthResult.user_email
                  });
                }else{
                    parentWindow.postMessage(OAuthHelper,
                              "https://www.linkedin.com");
                    window.close();
                }
                
                
                // window.close();
                
            },
            data: {code:decodeURIComponent(match[1])}
        });
    
    


  </script>
</body>
</html>